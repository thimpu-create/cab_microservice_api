<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Service Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .driver-panel { background-color: #e3f2fd; }
        .passenger-panel { background-color: #f3e5f5; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background-color: #4caf50; color: white; }
        .disconnected { background-color: #f44336; color: white; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #2196f3;
            color: white;
        }
        button:hover { background-color: #1976d2; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
        }
        .log {
            height: 300px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #2196f3;
            background-color: white;
        }
        .log-entry.error { border-left-color: #f44336; }
        .log-entry.success { border-left-color: #4caf50; }
    </style>
</head>
<body>
    <h1>ðŸš• Realtime Service Test</h1>
    <p><strong>Service URL:</strong> ws://localhost:8007</p>

    <div class="container">
        <!-- Driver Panel -->
        <div class="panel driver-panel">
            <h2>ðŸš— Driver</h2>
            <div>
                <input type="text" id="driverId" placeholder="Driver ID" value="driver-1">
                <button onclick="connectDriver()">Connect Driver</button>
                <button onclick="disconnectDriver()" id="driverDisconnectBtn" disabled>Disconnect</button>
            </div>
            <div id="driverStatus" class="status disconnected">Disconnected</div>
            
            <h3>Send Location Update</h3>
            <div>
                <input type="number" id="driverLat" placeholder="Latitude" value="40.7128" step="0.0001">
                <input type="number" id="driverLon" placeholder="Longitude" value="-74.0060" step="0.0001">
                <select id="driverStatusSelect">
                    <option value="available">Available</option>
                    <option value="on_ride">On Ride</option>
                    <option value="busy">Busy</option>
                </select>
                <button onclick="sendDriverLocation()" id="driverLocationBtn" disabled>Send Location</button>
            </div>
            
            <h3>Accept Ride</h3>
            <div>
                <input type="text" id="acceptRideId" placeholder="Request ID">
                <button onclick="acceptRide()" id="acceptRideBtn" disabled>Accept Ride</button>
            </div>
            
            <h3>Complete Ride</h3>
            <div>
                <input type="text" id="completeRideId" placeholder="Request ID">
                <button onclick="completeRide()" id="completeRideBtn" disabled>Complete Ride</button>
            </div>
            
            <h3>Driver Log</h3>
            <div id="driverLog" class="log"></div>
        </div>

        <!-- Passenger Panel -->
        <div class="panel passenger-panel">
            <h2>ðŸ‘¤ Passenger</h2>
            <div>
                <input type="text" id="passengerId" placeholder="Passenger ID" value="passenger-1">
                <button onclick="connectPassenger()">Connect Passenger</button>
                <button onclick="disconnectPassenger()" id="passengerDisconnectBtn" disabled>Disconnect</button>
            </div>
            <div id="passengerStatus" class="status disconnected">Disconnected</div>
            
            <h3>Request Ride</h3>
            <div>
                <input type="number" id="passengerLat" placeholder="Latitude" value="40.7580" step="0.0001">
                <input type="number" id="passengerLon" placeholder="Longitude" value="-73.9855" step="0.0001">
                <button onclick="requestRide()" id="requestRideBtn">Request Ride</button>
            </div>
            
            <h3>Passenger Log</h3>
            <div id="passengerLog" class="log"></div>
        </div>
    </div>

    <script>
        const WS_URL = 'ws://localhost:8007';
        let driverWs = null;
        let passengerWs = null;

        // Driver Functions
        function connectDriver() {
            const driverId = document.getElementById('driverId').value;
            if (!driverId) {
                alert('Please enter Driver ID');
                return;
            }

            driverWs = new WebSocket(`${WS_URL}/ws/driver/${driverId}`);
            
            driverWs.onopen = () => {
                addDriverLog('Connected to WebSocket', 'success');
                document.getElementById('driverStatus').textContent = 'Connected';
                document.getElementById('driverStatus').className = 'status connected';
                document.getElementById('driverDisconnectBtn').disabled = false;
                document.getElementById('driverLocationBtn').disabled = false;
                document.getElementById('acceptRideBtn').disabled = false;
                document.getElementById('completeRideBtn').disabled = false;
            };

            driverWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addDriverLog('Received: ' + JSON.stringify(data, null, 2), 'success');
                
                // Auto-fill request ID if ride request received
                if (data.type === 'ride_request') {
                    document.getElementById('acceptRideId').value = data.request_id;
                }
                if (data.type === 'ride_confirmed') {
                    document.getElementById('completeRideId').value = data.request_id;
                }
            };

            driverWs.onerror = (error) => {
                addDriverLog('Error: ' + error, 'error');
            };

            driverWs.onclose = () => {
                addDriverLog('Disconnected', 'error');
                document.getElementById('driverStatus').textContent = 'Disconnected';
                document.getElementById('driverStatus').className = 'status disconnected';
                document.getElementById('driverDisconnectBtn').disabled = true;
                document.getElementById('driverLocationBtn').disabled = true;
                document.getElementById('acceptRideBtn').disabled = true;
                document.getElementById('completeRideBtn').disabled = true;
            };
        }

        function disconnectDriver() {
            if (driverWs) {
                driverWs.close();
                driverWs = null;
            }
        }

        function sendDriverLocation() {
            if (!driverWs || driverWs.readyState !== WebSocket.OPEN) {
                alert('Driver not connected');
                return;
            }

            const lat = parseFloat(document.getElementById('driverLat').value);
            const lon = parseFloat(document.getElementById('driverLon').value);
            const status = document.getElementById('driverStatusSelect').value;

            const message = {
                lat: lat,
                lon: lon,
                status: status
            };

            driverWs.send(JSON.stringify(message));
            addDriverLog('Sent location: ' + JSON.stringify(message), 'success');
        }

        function acceptRide() {
            if (!driverWs || driverWs.readyState !== WebSocket.OPEN) {
                alert('Driver not connected');
                return;
            }

            const requestId = document.getElementById('acceptRideId').value;
            if (!requestId) {
                alert('Please enter Request ID');
                return;
            }

            const message = {
                type: 'accept_ride',
                request_id: requestId
            };

            driverWs.send(JSON.stringify(message));
            addDriverLog('Accepted ride: ' + requestId, 'success');
        }

        function completeRide() {
            if (!driverWs || driverWs.readyState !== WebSocket.OPEN) {
                alert('Driver not connected');
                return;
            }

            const requestId = document.getElementById('completeRideId').value;
            if (!requestId) {
                alert('Please enter Request ID');
                return;
            }

            const message = {
                type: 'completed_ride',
                request_id: requestId
            };

            driverWs.send(JSON.stringify(message));
            addDriverLog('Completed ride: ' + requestId, 'success');
        }

        function addDriverLog(message, type = '') {
            const log = document.getElementById('driverLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Passenger Functions
        function connectPassenger() {
            const passengerId = document.getElementById('passengerId').value;
            if (!passengerId) {
                alert('Please enter Passenger ID');
                return;
            }

            passengerWs = new WebSocket(`${WS_URL}/ws/passenger/${passengerId}`);
            
            passengerWs.onopen = () => {
                addPassengerLog('Connected to WebSocket', 'success');
                document.getElementById('passengerStatus').textContent = 'Connected';
                document.getElementById('passengerStatus').className = 'status connected';
                document.getElementById('passengerDisconnectBtn').disabled = false;
            };

            passengerWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addPassengerLog('Received: ' + JSON.stringify(data, null, 2), 'success');
            };

            passengerWs.onerror = (error) => {
                addPassengerLog('Error: ' + error, 'error');
            };

            passengerWs.onclose = () => {
                addPassengerLog('Disconnected', 'error');
                document.getElementById('passengerStatus').textContent = 'Disconnected';
                document.getElementById('passengerStatus').className = 'status disconnected';
                document.getElementById('passengerDisconnectBtn').disabled = true;
            };
        }

        function disconnectPassenger() {
            if (passengerWs) {
                passengerWs.close();
                passengerWs = null;
            }
        }

        async function requestRide() {
            const passengerId = document.getElementById('passengerId').value;
            const lat = parseFloat(document.getElementById('passengerLat').value);
            const lon = parseFloat(document.getElementById('passengerLon').value);

            if (!passengerId || !lat || !lon) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch('http://localhost:8007/api/v1/rides/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passenger_id: passengerId,
                        lat: lat,
                        lon: lon
                    })
                });

                const result = await response.json();
                addPassengerLog('Ride requested: ' + JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                addPassengerLog('Error requesting ride: ' + error.message, 'error');
            }
        }

        function addPassengerLog(message, type = '') {
            const log = document.getElementById('passengerLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
